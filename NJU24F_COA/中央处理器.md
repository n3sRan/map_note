# 中央处理器

[TOC]

## CPU的功能和结构

*CPU需要提供哪些功能? 对应这些功能需要有哪些结构?*

**运算器 + 控制器**

### 功能

#### CPU的功能

- 指令控制. 完成取指令, 分析指令和执行指令的操作, 即程序的顺序控制.
- 操作控制. 一条指令的功能往往是由若干操作信号的组合来实现的. CPU管理并产生由内存取出的每条指令的操作信号, 把各种操作信号送往相应的部件, 从而控制这些部件按指令的要求进行动作.
- 时间控制. 对各种操作加以时间上的控制. 时间控制要为每条指令按时间顺序提供应有的控制信号.
- 数据加工. 对数据进行算术和逻辑运算.
- 中断处理. 对计算机运行过程中出现的异常情况和特殊请求进行处理

#### 运算器的功能

- 对数据进行加工


#### 控制器的功能

- 取指令: 自动形成指令地址;自动发出取指令的命令. 
- 分析指令: 操作码译码 (分析本条指令要完成什么操作); 产生操作数的有效地址.
- 执行指令: 根据分析指令得到的操作命令和操作数地址形成操作信号控制序列, 控制运算器, 存储器以及I/0设备完成相应的操作.
- 中断处理:管理总线及输入输出; 处理异常情况 (如掉电) 和特殊请求 (如打印机请求打印一行字符).

### 基本结构

#### 运算器的基本结构

![](../0_Attachment/Pasted%20image%2020241203182526.png)

#### 数据通路的基本结构

##### CPU内部单总线方式

- 将所有寄存器的输入端和输出端都连接到一条公共的通路上.
- 结构简单, 容易实现, 但数据传输存在较多冲突的现象, 性能较低.
- 如上图

##### 专用数据通路方式

- 根据指令执行过程中的数据和地址的流动方向安排连接线路 (相当于一对一).
- 如果直接用导线连接, 相当于多个寄存器同时并且一直向ALU传输数据
  - 解决方法1: 使用多路选择器根据控制信号选择一路输出
  - ![](../0_Attachment/Pasted%20image%2020241203195802.png)
  - 解决方法2: 使用三态门可以控制每一路是否输出
  - ![](../0_Attachment/Pasted%20image%2020241203195833.png)
- 性能较高, 基本不存在数据冲突现象, 但结构复杂, 硬件量大, 不易实现.

#### 控制器基本结构

![](../0_Attachment/Pasted%20image%2020241203200611.png)

### CPU基本结构

两图的组合

![](../0_Attachment/Pasted%20image%2020241203201137.png)

## 指令执行过程

### 指令周期

**指令周期**: CPU从主存中每取出并执行一条指令所需的全部时间. 可分为取指周期和执行周期

指令周期常常用若干**机器周期**来表示, 机器周期又叫**CPU周期**

一个机器周期又包含若干**时钟周期**(也称为节拍, T周期或CPU时钟周期, 它是CPU操作的最基本单位)

每个机器周期又可以细化为取指周期, 间址周期, 执行周期, 中断周期

每个指令周期内机器周期数可以不等, 每个机器周期内的节拍数也可以不等.

为了区分当前指令执行处于哪个周期, 可以设置**标志触发器**来表示.

![](../0_Attachment/Pasted%20image%2020241203202404.png)

![	](../0_Attachment/Pasted%20image%2020241203202752.png)

![](../0_Attachment/Pasted%20image%2020241204132232.png)

### 数据流

在不同阶段CPU内部的数据流动是不同的.

注意访存目的是不同的.

- 取指周期
  - 根据PC中的内容取出指令代码并存放在IR中
  - ![](../0_Attachment/Pasted%20image%2020241204133309.png)
- 间址周期
  - 根据IR中指令地址码取操作数有效地址
  - ![](../0_Attachment/Pasted%20image%2020241204133350.png)
- 执行周期
  - 执行周期的任务是根据IR中的指令字的操作码和操作数通过ALU操作产生执行结果不同指令的执行周期操作不同, 因此没有统一的数据流向。
- 中断周期
  - 保存断点, 送中断向量, 处理中断请求
  - ![](../0_Attachment/Pasted%20image%2020241204133535.png)

### 执行方案

一个指令周期通常要包括几个时间段(执行步骤), 每个步骤完成指令的一部分功能, 几个依次执行的步骤完成这条指令的全部功能

- 单指令周期: 所有指令选用相同的执行时间, 指令间串行
- 多指令周期: 不同类型指令选用不同的执行步骤, 指令间串行
- 流水线方案: 隔一段时间启动一条指令, 多条指令处于不同阶段, 同时运行

## 数据通路的功能和基本结构

如何设置部件之间的连接路径?

描述指令执行过程中信号和数据在这些路径上的传输

### CPU内部总线

#### 单总线

同一时刻只能有一组部件通过总线进行数据的传送 (ALU需配合暂存器使用).

由**控制部件CU**产生的**控制信号**建立数据通路.

![](../0_Attachment/Pasted%20image%2020241204210640.png)

#### 多总线

类似单总线

### 专用通路结构

![](../0_Attachment/Pasted%20image%2020241204213138.png)

## 控制器的功能和工作原理

控制器如何指挥整个系统的工作?


控制器的设计

硬布线

微程序

## 指令流水线

为什么引入流水线的结构?

有哪些结构?

会产生什么问题?

### 基本概念

一条指令的执行过程可以分成多个阶段, 例如取指-译码-执行, 每个阶段用到的硬件不一样

占用不同的资源, 就能使多条指令同时执行

- 顺序执行方式
  - $T = nkt$
  - 传统冯·诺依曼机采用顺序执行方式, 又称串行执行方式。
  - 优点:控制简单, 硬件代价小。
  - 缺点:执行指令的速度较慢, 在任何时刻, 处理机中只有一条指令在执行, 各功能部件的利用率很低。
- a次重叠执行方式
  - $T = kt + (n-1)(k-a)t$
  - 优点:程序的执行时间缩短了$a/k$,各功能部件的利用率明显提高.
  - 缺点:需要付出硬件上较大开销的代价, 控制过程也比顺序执行复杂了.

表示方法

- 流程指令图
  - 主要用于分析影响流水线的因素
  - ![](../0_Attachment/Pasted%20image%2020241204214641.png)
- 时空图
  - 主要用于分析流水线的性能
  - ![](../0_Attachment/Pasted%20image%2020241204214705.png)

### 性能指标

在单位时间内流水线所完成的任务数量, 或是输出结果的数量

设任务数为n, 处理完成$n$个任务所用的时间为$T_k$, 则计算流水线吞吐率 (TP) 的最基本的公式为 $TP = n / T_k$.

#### 加速比S

完成同样一批任务, 不使用流水线所用的时间与使用流水线所用的时间之比.

#### 效率E

流水线的设备利用率称为流水线的效率.

在时空图上, 流水线的效率定义为完成n个任务占用的时空区有效面积与n个任务所用的时间与k个流水段所围成的时空区总面积之比.

### 影响因素

#### 结构相关 (资源冲突)

- 由于多条指令在同一时刻争用同一资源而形成的冲突称为结构相关。
- 解决办法:
  1.后一相关指令暂停一周期
  2.资源重复配置:数据存储器+指令存储器

#### 数据相关 (数据冲突)

- 数据相关指在一个程序中，存在必须等前一条指令执行完才能执行后一条指令的情况,则这两条指令即为数据相关.

- ![](../0_Attachment/Pasted%20image%2020241204221345.png)

- 解决办法

  1. 把遇到数据相关的指令及其后续指令都暂停一至几个时钟周期, 直到数据相关问题消失后再继续执行可分为**硬件阻塞 (stall)** 和**软件插入NOP (空指令)** 两种方法.
     - 硬件阻塞
     - ![](../0_Attachment/Pasted%20image%2020241204221321.png)
     - 软件插入空指令
     - ![](../0_Attachment/Pasted%20image%2020241204221330.png)
2. 数据旁路技术
  3. 编译优化: 通过编译器调整指令顺序来解决数据相关

#### 控制相关 (控制冲突)

- 当流水线遇到转移指令和其他改变PC值的指令 (分支, 函数调用/返回, 中断)而造成断流时，会引起控制相关.
- ![](../0_Attachment/Pasted%20image%2020241204222110.png)
- 解决办法:
  1. 转移指令分支预测. 简单预测(永远猜true或false), 动态预测 (根据历史情况动态调整)
  2. 预取转移成功和不成功两个控制流方向上的目标指令
  3. 加快和提前形成条件码
  4. 提高转移方向的猜准率

### 流水线的分类

- 按使用级别: 部件功能级, 处理机级, 处理机间
- 按完成功能: 单功能, 多功能
- 按连接方式: 动态, 静态
- 按有无反馈信号: 线性, 非线性

### 流水线的多发技术

#### 超标量技术

*空分复用技术*

- 每个时钟周期内可并发多条独立指令
- 要配置多个功能部件
- 不能调整指令的执行顺序
- 通过编译优化技术, 把可并行执行的指令搭配起来

#### 超流水技术

*时分复用技术*

- 在一个时钟周期内再分段
- 在一个时钟周期内一个功能部件使用多次
- 不能调整指令的执行顺序
- 靠编译程序解决优化问题

#### 超长指令字

- 编译程序挖掘出指令间潜在的并行性
- 将多条能并行操作的指令组合成一条具有多个操作码字段的超长指令字 (可达几百位)