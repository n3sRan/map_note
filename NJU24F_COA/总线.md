# 总线

[TOC]

## 总线概述

*同一时刻只能有一个部件发送数据, 但是可有多个部件接受数据*

### 定义

总线是一组能为多个部件**分时共享**的公共信息传送线路. 

- **共享**是指总线上可以挂接多个部件, 各个部件之间互相交换的信息都可以通过这组线路分时共享. 
- **分时**是指同一时刻只允许有一个部件向总线发送信息, 如果系统中有多个部件, 则它们只能分时地向总线发送信息
- 为什么要用总线?
  - 早期计算机外部设备少时大多采用分散接方式, 但不易实现随时增减外部设备.
  - 为了更好地解决I/O设备和主机之间连接的灵活性问题, 计算机的结构从**分散连接**发展为**总线连接**.

### 特性

- 机械特性: 尺寸, 形状, 排列顺序管脚数
- 电气特性: 传输方向和有效的电平范围
- 功能特性: 每根传输线的功能 (地址, 数据, 控制)
- 时间特性: 信号的时序关系

### 分类

#### 按数据传输格式

串行总线

- 每次传1位, USB
- 优点:只需要一条传输线, 成本低廉, 广泛应用于长距离传输,  应用于计算机内部时, 可以节省布线空间.
- 缺点:在数据发送和接收的时候要进行拆卸和装配, 要考虑串行, 并行转换的问题. 

并行总线

- 每次传多位
- 优点: 总线的逻辑时序比较简单, 电路实现起来比较容易. 
- 缺点:信号线数量多, 占用更多的布线空间,  远距离传输成本高昂,  由于工作频率较高时, 并行的信号线之间会产生严重干扰对每条线等长的要求也越高以无法持续提升工作频率. 

#### 按功能 (连接的部件)

*数据通路表示的是数据流经的路径, 数据总线是承载的媒介*

片内总线

- 芯片内部的总线.
- 是CPU芯片内部寄存器与寄存器之间, 寄存器与ALU之间的公共连接线.

系统总线

- 计算机系统内各功能部件 (CPU, 主存, I/O接口)之间相互连接的总线
- 按系统总线传输信息内容的不同, 又可分为**数据总线**, **地址总线**和**控制总线**. 
  - 数据总线用来传输各功能部件之间的数据信息, 它是**双向**传输总线, 其位数与机器字长, 存储字长有关. 
  - 地址总线用来指出数据总线上的源数据或目的数据所在的主存单元或I/O端口的地址, 它是**单向**传输总线, 地址总线的位数与主存地址空间的大小有关. 
  - 控制总线传输的是控制信息, 包括CPU送出的控制命令和主存 (或外设) 返回CPU的反馈信号. (单论一条为单向传输, 总体来看为双向传输)
  - ![[../0_Attachment/Pasted image 20241128105034.png]]

通信总线

- 用于计算机系统之间或计算机系统与其他系统 (如远程通信设备, 测试设备)之间信息传送的总线, 通信总线也称为外部总线. 

#### 按时序控制方式

同步

异步

### 总线结构

- 单总线结构
  - CPU, 主存, I/O设备 (通过I/O接口) 都连接在一组总线 (包含了数据总线, 地址总线和控制总线) 上, 允许I0设备之间, IO设备和CPU之间或IO设备与主存之间直接交换信息.
  - 优点: 结构简单, 成本低, 易于扩展 (接入新的设备).
  - 缺点: 带宽低, 负载重, 多个部件只能争用唯一的总线, 且不支持并发传送操作.
  - ![[../0_Attachment/Pasted image 20241128103953.png]]
- 双总线结构1
  - 在CPU和存储器中间增加一个存储器总线
  - 优点: 增加CPU和存储器之间的传输效率, 同时降低系统总线的负担
  - ![[../0_Attachment/Pasted image 20241128104930.png]]
- 双总线结构2
  - 有两条总线, 一条是主存总线, 用于CPU, 主存和**通道**之间进行数据传送,  另一条是I/O总线, 用于多个外部设备与通道之间进行数据传送. 
  - 优点: 将较低速的I/O设备从单总线上分离出来, 实现存储器总线和I/O总线分离.
  - 缺点: 需要增加通道等硬件设备
  - **通道**: input/output processer, IOP, 具有特殊功能的处理器, 能对I/O设备进行统一管理. 通道程序放在主存中
  - 内存总线支持突发 (猝发) 传送: 送出一个地址, 中收到多个地址连续的数据
  - ![[../0_Attachment/Pasted image 20241128104914.png]]
- 多总线结构1
  - 增加一个本地总线 (local bus) 来连接CPU和cache
  - 优点：分离了CPU和I/O的交互
  - ![[../0_Attachment/Pasted image 20241128104858.png]]
- 多总线结构2
  - 在计算机系统各部件之间采用3条各自独立的总线来构成信息通路, 这3条总线分别为主存总线, I/O总线和直接内存访问DMA总线. (DMA: Direct Memory Access, 直接内存访问)
  - 优点:提高了I/O设备的性能, 使其更快地响应命令, 提高系统吞吐量.
  - 缺点:系统工作效率较低 (三个总线同一时刻只能有一个总线在工作)
  - ![[../0_Attachment/Pasted image 20241128104844.png]]
- 多总线结构3 (四总线结构)
  - CPU总线, 系统总线 (存储器总线), 高速I/O总线, 扩充总线 (低速I/O总线)
  - **桥接器**: 用于连接不同的总线, 具有数据缓冲, 转换和控制功能.
  - 靠近CPU的总线速度较快
  - ![[../0_Attachment/Pasted image 20241128104820.png]]

## 总线的性能指标

### 总线的传输周期 (总线周期)

一次总线操作所需的时间 (包括申请阶段:寻址阶段, 传输阶段和结束阶段), 通常油若干个总线时钟周期构成. 

### 总线时钟周期

即机器的时钟周期. 计算机有一个统一的时钟, 以控制整个计算机的各个部件, 总线也要受此时钟的控制

现在的计算机中总线时钟周期也有可能由桥接器提供

- 大多数情况下, 一个总线周期包含多个总线时钟周期
- 有的时候, 一个总线周期就是一个总线时钟周期
- 有的时候, 一个总线时钟周期可包含多个总线周期

### 总线的工作频率

总线上各种操作的频率, 为总线周期的倒数, 若总线周期=N个时钟周期, 则总线的工作频率=时钟频率/N. 实际上指一秒内传送几次数据.

### 总线的时钟频率

即机器的时钟频率, 为时钟周期的倒数, 若时钟周期为T, 则时钟频率为1/T. 实际上指一秒内有多少个时钟周期

### 总线宽度

bus width

组成总线的线数

又称为总线位宽, 它是总线上同时能够传输的数据位数, 通常是指数据总线的根数, 如32根称为32位 (bit) 总线.

### 总线带宽

bus bandwidth

可理解为总线的数据传输率, 即单位时间内总线上可传输数据的位数, 通常用每秒钟传送信息的字节数来衡量, 单位可用字节/秒 (B/s) 表示. 

指总线本身所能达到的**最高传输速率**, 在计算实际的有效数据传输率, 要用实际传输的数据量除以耗时. *(可结合COA12讲PPT的例题进行理解)*

总线带宽 = 总线工作频率 × 总线宽度 (bit/s) = 总线工作频率 × (总线宽度 / 8) (B/s)

### 总线复用

指一种信号线在不同的时间传输不同的信息

可以使用较少的线传输更多的信息, 从而节省了空间和成本.

### 信号线数

地址总线, 数据总线和控制总线3种总线数的总和称为信号线数.

## 总线仲裁

如何解决多个和设备争用总线的问题?

### 基本概念

同一时刻只能有一个设备控制总线传输操作, 可以有一个或多个设备从总线接收数据.

将总线上所连接的各类设备按其对总线有无控制功能分为:

主设备: 获得总线控制权的设备.

从设备: 被主设备访问的设备, 只能响应从主设备发来的各种总线命令.

为什么要仲裁?

- 总线作为一种共享设备, 不可避免地会出现同一时刻有多个主设备竞争总线控制权的问题.

总线仲裁的定义

- 多个主设备同时竞争主线控制权时, 以某种方式选择一个主设备优先获得总线控制权称为总线仲裁

分类

- 集中仲裁: 链式查询方式, 计数器定时查询方式, 独立请求方式
- 分布仲裁

### 集中仲裁方式

流程:

1. 主设备发出请求信号.
2. 若多个主设备同时要使用总线, 则由总线控制器 (一般集成在CPU) 的判优, 仲裁逻辑按一定的优先等级顺序确定哪个主设备能使用总线.
3. 获得总线使用权的主设备开始传送数据.

#### 链式查询方式

- 控制信号
  - BG: 总线允许
  - BR: 总线请求 
  - BS: 总线忙 (信号建立者为获得总线控制权的设备)
- 优先级
  - 离总线控制器越近的部件, 其优先级越高
  - 离总线控制器越远的部件, 其优先级越低
- 优点:链式查询方式优先级固定.只需很少几根控制线就能按一定优先次序实现总线控制, 结构简单, 扩充容易
- 缺点:对硬件电路的故障敏感, 并且优先级不能改变.当优先级高的部件频繁请求使用总线时, 会使优先级较低的部件长期不能使用总线
- ![[../0_Attachment/Pasted image 20241128105123.png]]

#### 计数器定时查询方式

- 结构特点: 用一个**计数器**控制总线使用权, 相对链式查询方式多了一组设备地址线, 少了一根总线响应线BG, 它仍共用一根总线请求线
- 过程
  - 当总线控制器收到总线请求信号, 判断总线空闲时, 计数器开始计数, 计数值通过设备地址线发向各个部件
  - 当地址线上的计数值与请求使用总线设备的地址一致时, 该设备获得总线控制权. 同时, 中止计数器的计数及查询
- 优点
  - 计数初始值可以改变优先次序, 若计数每次从0开始, 设备的优先级就按顺序排列, 固定不变. 若计数从上一次的终点开始, 此时设备使用总线的优先级相等, 计数器的初值还可以由程序设置
  - 对电路的故障没有链式敏感
- 缺点
  - 增加了控制线数 (若有n个设备, 控制线数为$\log_{2}n + 2 $ 向上取整)
  - 控制相对比链式查询相对复杂
- ![[../0_Attachment/Pasted image 20241128105204.png]]

#### 独立请求方式

- 结构特点:每一个设备均有一对总线请求线$BR_i$和总线允许线$BG_i$
- 过程
  - 当总线控制器按一定的优先次序决定批准某个部件的请求时, 则给该部件发送总线响应信号.
  - 当总线上的部件需要使用总线时, 经各自的总线请求线发送总线请求信号, 在总线控制器中排队.
- 优点
  - 响应速度快, 总线允许信号BG直接从控制器发送到有关设备, 不必在设备间传递或者查询
  - 对优先次序的控制相当灵活. (可编程)
- 缺点
  - 控制线数量多 (若有n个设备, 控制线数为$2n + 2 $)
  - 总线的控制逻辑更加复杂
- ![[../0_Attachment/Pasted image 20241128105216.png]]

### 分布仲裁方式

特点: 不需要中央仲裁器, 每个潜在的主模块都有自己的仲裁器和仲裁号, 多个仲裁器竞争使用总线

过程

- 当设备有总线请求时, 它们就把各自唯一的仲裁号发送到共享的仲裁总线上
- 每个仲裁器将从仲裁总线上得到的仲裁号与自己的仲裁号进行比较
- 如果仲裁总线上的号优先级高, 则它的总线请求不予响应, 并销它的仲裁号
- 最后, 获胜者的仲裁号保留在仲裁总线上

*扩展: COA内容*

#### 自举式

- 如上, 优先级固定

#### 冲突检测

当一个设备想要使用总线时, 它会检查总线是否繁忙

- 如果总线空闲, 设备使用总线
- 冲突处理: 如果两个设备发现总线空闲, 它们可能同时使用总线
  - 在传输数据时, 设备会监听总线, 检查是否存在冲突
  - 如果发生冲突, 所有使用总线的设备将停止数据传输, 并分别在随机时间间隔后再次请求总线

## 总线操作和定时

占用总线的一对设备如何进行数据传输?

### 总线周期的四个阶段

1. 申请分配防段: 由需要使用总线的主模块(或主设备)提出申请, 经总线仲裁机构决定将下一传输周期的总线使用权授予某一申请者. 也可将此阶段细分为**传输请求**和**总线仲裁**两个阶段.
2. 寻址阶段: 获得使用权的主模块通过总线发出本次要访问的从模块的地址及有关命令, 启动参与本次传输的从模块.
3. 传输阶段: 主模块和从模块进行数据交换, 可单向或双向进行数据传送.
4. 结束阶段: 主模块的有关信息均从系统总线上撤除, 让出总线使用权.

**总线定时**是指总线在双方交换数据的过程中需要**时间上配合**关系的控制, 这种控制称为总线定时, 它的实质是一种协议或规则.

### 同步定时方式 (同步通信)

- 指系统采用一个统一的时钟信号来协调发送和接收双方的传送定时关系.

- 若干个时钟产生相等的时间间隔, 每个间隔构成一个总线周期.

- 在一个总线周期中, 发送方和接收方可进行一次数据传送

- 因为采用统一的时钟, 每个部件或设备发送或接收信息都在固定的总线传送周期中, 一个总线的传送周期结束, 下一个总线传送周期开始.

- 优点:传送速度快, 具有较高的传输速率; 总线控制逻辑简单.

- 缺点:主从设备属于强制性同步; 不能及时进行数据通信的有效性检验, 可靠性较差. (如果从设备跟不上就出问题了)

- 同步通信适用于总线长度较短及总线所接部件的存取时间比较接近的系统.


### 异步定时方式 (异步通信)

在异步定时方式中, 没有统一的时钟, 也没有固定的时间间隔, 完全依靠传送双方相互制约的"握手"信号来实现定时控制.

主设备提出交换信息的"请求"信号, 经接口传送到从设备;从设备接到主设备的请求后, 通过接口向主设备发出"回答"信号

根据"请求"和"回答"信号的撤销是否互锁, 分为以下3种类型

- 不互锁方式 No interlock (速度最快, 可靠性最差)
  - 主设备发出"请求"信号后 (如地址信息+读命令), 不必等到接到从设备的"回答"信号, 而是经过一段时间, 便撤销"请求"信号. (一次握手)
  - 而从设备在接到"请求"信号后, 发出"回答"信号 (如要读出的数据), 并经过一段时间, 自动撤销"回答"信号.
  - 双方不存在互锁关系.
- 半互锁方式 Semi-interlock
  - 主设备发出"请求"信号后, 必须待接到从设备的"回答"信号后, 才撤销"请求"信号, 有互锁的关系. (两次握手)
  - 而从设备在接到"请求"信号后, 发出"回答"信号, 但不必等待获知主设备的"请求"信号已经撤销, 而是隔一段时间后自动撤销"回答"信号, 不存在互锁关系.
- 全互锁方式 Interlock (最可靠, 速度最慢)
  - 主设备发出"请求"信号后, 必须待从设备"回答"后, 才撤销"请求"信号;
  - 从设备发出"回答"信号, 必须待获知主设备"请求"信号已撤销后, 再撤销其"回答"信号. (三次握手)
  - 双方存在互锁关系.

优点:总线周期长度可变, 能保证两个工作速度相差很大的部件或设备之间可靠地进行信息交换, 自动适应时间的配合.

缺点:比同步控制方式稍复杂一些, 速度比同步定时方式慢

### 半同步通信

- 同步
  - 发送方用系统时钟前沿发信号
  - 接收方用系统时钟后沿判断, 识别
- 异步
  - 允许不同速度的模块和谐工作
- 统一时钟的基础上, 增加一个等待响应信号WAIT

### 分离式通信

- 一个总线传输周期分为两个子周期
  - 子周期1: 主模块申请占用总线, 使用完后放弃总线的使用权
  - 子周期2: 从模块申请占用总线, 将各种信息送至总线上
- 特点
  - 各模块均有权申请占用总线
  - 采用同步方式通信, 不等对方回答
  - 各模块准备数据时, 不占用总线
  - 总线利用率提商

## 总线标准

*不考*

易于实现系统的模块化设计, 上述过程的多种方式用哪种?

### 基本概念

总线标准是国际上公布或推荐的互连各个模块的标准, 它是把各种不同的模块组成计算机系统时必须遵守的规范. 按总线标准设计的接口可视为通用接口, 在接口的两端, 任何一方只需根据总线标准的要求完成自身方面的功能要求, 而无须了解对方接口的要求.

根据总线在计算机系统中的位置, 可分为

- 系统总线: 通常与CPU直接相连, 用于连接CPU与北桥芯片, 或CPU与主存等
- 局部总线: 没有直接与CPU连接, 通常是连接高速的北桥芯片, 用于连接了很多重要的硬件部件, 如显卡, 声卡等
- 设备总线, 通信总线: 通常由南桥芯片控制, 用于连接计算机与计算机, 或连接计算机与外部I/O设备

### 系统总线标准

| 总线标准 | 全称                           | 工作频率 | 数据线 | 最大速度 | 特点 |
| -------- | ------------------------------ | -------- | ------ | -------- | ---- |
| ISA      | Industry Standard Architecture | 8MHz     | 8/16   | 8MB/s    | 并行 |
| EISA     | Extend ISA                     | 8MHz     | 32     | 32MB/s   | 并行 |

### 局部总线标准

| 总线标准 | 全称                              | 工作频率 | 数据线 | 最大速度                 | 特点                       |
| -------- | --------------------------------- | -------- | ------ | ------------------------ | -------------------------- |
| VESA     | Recommended Standard              | 33MHz    | 32     | 132MB/s                  | 并行                       |
| PCI      | Peripheral Component Interconnect | 33MHz    | 32     | 133MB/s                  | 并行                       |
| AGP      | Accelerated Graphics Port         |          |        | X1: 266MB/s, X8: 2.1GB/s | 并行                       |
| PCI-E    | PCI-Express (3GIO)                |          |        | 10GB/s以上               | 点对点串行连接, 支持热插拔 |

### 设备总线标准

| 总线标准      | 全称                                                      | 工作频率 | 数据线 | 最大速度     | 特点         |
| --------- | ------------------------------------------------------- | ---- | --- | -------- | ---------- |
| RS-232C   | Recommended Standard                                    |      |     | 20Kbps   | 串行通信总线     |
| SCSI      | Small Computer System Interface                         |      |     | 640MB/s  | 智能通用接口, 并行 |
| PCMCIA    | Personal Computer Memory Card International Association |      |     | 90Mbps   | 便携设备接口, 并行 |
| USB       | Universal Serial Bus                                    |      |     | 1280MB/s | 设备总线, 串行   |
| IDE (ATA) | Integrated Drive Electronics                            |      |     | 100MB/s  | 硬盘光驱接口, 并行 |
| SATA      | Serial Advanced Technology Attachment                   |      |     | 600MB/s  | 串行硬盘接口     |

USB-A接口

- 1 红 VCC: 供电端
- 2 白 -D
- 3 绿 +D
- 4 黑 GND: 接地端
- 差模信号: 根据2, 3的压差来确定1bit数据, 差模信号的抗干扰能力很强, 因此工作频率可以很高
- 注意: USB每次只能传输1bit数据
- ![[../0_Attachment/Pasted image 20241128114248.png]]

为何串行取代并行?

- 并行总线: 用m根线每次传送m个比特, 用高/低电平表示1/0, 通常采用同步定时方式, 由于线间信号干扰, 因此总线工作频率不能太高. 另外, 各条线不能有长度差, 长距离并行传输时工艺难度大.
- 串行总线: 用两根线每次传送一个比特, 采用“差模信号”表示1/0, 通常采用异步定时方式, 总线工作频率可以很高. 现在的串行总线通常基于**包传输**, 如80bit为一个数据包, 包与包之间有先后关系, 因此可以用多个数据通路分别串行传输多个数据包. 因此某种程度上现在的串行总线也有"并行"的特点.